# fly.toml - Fly.io configuration for NEAR Treasury Sandbox Test Environment
# Deploy with: fly deploy --config sandbox/fly.toml
#
# This deploys a single machine with:
# - NEAR Sandbox (port 3030)
# - Bulk Payment API (port 8080)
# - Sputnik DAO Indexer (port 5001)

app = 'near-treasury-sandbox'
primary_region = 'ams'

[build]
dockerfile = "Dockerfile"

[env]
# NEAR Sandbox configuration
NEAR_RPC_URL = 'http://localhost:3030'

# Bulk Payment API configuration
BULK_PAYMENT_CONTRACT_ID = 'bulk-payment.near'
API_PORT = '8080'

# Sputnik Indexer configuration
INDEXER_PORT = '5001'
PORT = '5001'
ROCKET_ADDRESS = '0.0.0.0'
ROCKET_PORT = '5001'

# Expose NEAR Sandbox RPC (port 3030)
[[services]]
internal_port = 3030
protocol = "tcp"

[[services.ports]]
handlers = ["tls", "http"]
port = 3030

[[services.http_checks]]
interval = "10s"
timeout = "5s"
grace_period = "30s"
method = "GET"
path = "/status"

# Expose Bulk Payment API (port 8080)
[[services]]
internal_port = 8080
protocol = "tcp"

[[services.ports]]
handlers = ["tls", "http"]
port = 8080

[[services.http_checks]]
interval = "10s"
timeout = "5s"
grace_period = "30s"
method = "GET"
path = "/health"

# Sputnik Indexer (port 5001)
# Note: No health check - sputnik-indexer doesn't have a /health endpoint
# The service responds with 404 for non-existent DAOs, which is expected behavior
[[services]]
internal_port = 5001
protocol = "tcp"

[[services.ports]]
handlers = ["tls", "http"]
port = 5001

# VM configuration
[[vm]]
memory = '4gb'
cpu_kind = 'shared'
cpus = 2

# Persistent volume for sandbox state and indexer cache
[mounts]
source = "sandbox_data"
destination = "/data"
